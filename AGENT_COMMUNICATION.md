# Agent Communication Protocol

**Дата:** 24 февраля 2026
**Версия:** 1.0.0

---

## Обзор

Этот документ описывает протокол коммуникации между AI-агентами в проекте Chat. Определяет как агенты вызывают друг друга, передают контекст и координируют работу.

---

## 1. Архитектура агентов

### 1.1 Иерархия

```
                    ┌──────────────────┐
                    │   USER REQUEST   │
                    └────────┬─────────┘
                             │
                    ┌────────▼─────────┐
                    │       CTO        │ ← Fallback, routing
                    └────────┬─────────┘
                             │
     ┌───────────────────────┼───────────────────────┐
     │                       │                       │
┌────▼─────┐          ┌──────▼──────┐         ┌─────▼──────┐
│  CLIENT  │          │   SERVER    │         │   DEVOPS   │
│   LEAD   │          │    LEAD     │         │    LEAD    │
└────┬─────┘          └──────┬──────┘         └─────┬──────┘
     │                       │                       │
┌────┴────┐ ┌────┐    ┌──────┴──────┐      ┌───────┴───────┐
│         │ │    │    │              │      │               │
│ Dev QA  │ │Sec │    │ Dev   QA Sec │      │ DevOps  QA    │
│         │ │    │    │              │      │               │
└─────────┘ └────┘    └──────────────┘      └───────────────┘

ОПЕРАЦИОННЫЙ УРОВЕНЬ (параллельно):
- Client Developer, Server Developer, Designer
- DevOps, QA, Security, Performance, Accessibility, Localization
- Metrics, Analytics, Docs
```

### 1.2 Типы агентов

| Тип | Роль | Примеры | Режим |
|-----|------|---------|-------|
| **Координаторы** | Принимают решения, распределяют | CTO, Leads | Последовательно |
| **Исполнители** | Выполняют задачи | Developers | Параллельно |
| **Аналитики** | Проверяют, оценивают | QA, Security | Параллельно |
| **Поддержка** | Документация, метрики | Docs, Metrics | Параллельно |

---

## 2. Trigger Keywords

### 2.1 Как работает маршрутизация

```
User Input
     │
     ▼
┌─────────────────────────────────────────┐
│  agents_mapping.json                    │
│  (keyword → subagent mapping)           │
└─────────────────────────────────────────┘
     │
     ▼
     Выбор агента по ключевым словам
     │
     ▼
┌─────────────────────────────────────────┐
│  SKILL.md выбранного агента             │
│  (загружает контекст и обязанности)     │
└─────────────────────────────────────────┘
```

### 2.2 Матрица ключевых слов

| Ключевое слово | Агент | Приоритет |
|----------------|-------|-----------|
| UI, SwiftUI, экран, компонент | Client Developer | 1 |
| архитектура, технологии | CTO | 1 |
| iOS, клиентская часть | Client Lead | 1 |
| API, сеть, LM Studio | Server Developer | 1 |
| серверная часть | Server Lead | 1 |
| дизайн, визуальный | Designer | 1 |
| безопасность, токен | Server/Client Security | 1 |
| тестирование, QA | QA Lead | 1 |
| документация | Documents Lead | 1 |
| локализация, i18n | Localization Engineer | 1 |
| iPad, macOS, widget | Platform Engineer | 1 |
| производительность | Performance Engineer | 1 |
| accessibility, voiceover | Accessibility Engineer | 1 |
| analytics, event tracking | Analytics Engineer | 1 |
| roadmap, план | Product Manager | 1 |
| рефакторинг | Staff Engineer | 1 |

---

## 3. Паттерны вызова

### 3.1 Прямой вызов (по ключевым словам)

```
User: "Добавь экран истории чатов"

Система:
1. Находит "экран", "история" → Client Developer
2. Загружает SKILL.md
3. Запускает агента с контекстом проекта
```

### 3.2 Иерархический вызов (через Lead)

```
User: "Сделай безопасное API"

CTO анализирует → "Нужен Server Lead + Security"

1. CTO → Server Lead: "Организуй безопасность API"
2. Server Lead → Server Developer: "Реализуй"
3. Server Lead → Server Security Engineer: "Проведи аудит"
4. Server Lead → Server QA Lead: "Протестируй"
```

### 3.3 Параллельный вызов

```
User: "Улучши производительность и добавь accessibility"

CTO → запускает параллельно:
├── Client Performance Engineer
└── Client Accessibility Engineer

Оба работают одновременно в разных областях
```

### 3.4 Chain вызов (последовательный)

```
User: "Новый экран настроек"

1. Client Lead → Designer: "Спроектируй"
2. Client Lead → Client Developer: "Реализуй"
3. Client Lead → Client QA Lead: "Протестируй"
4. Client Lead → Client Security Engineer: "Аудит"
```

---

## 4. Передача контекста

### 4.1 Что передаётся между агентами

| Параметр | Описание | Пример |
|----------|----------|--------|
| **task** | Описание задачи | "Добавить экран истории" |
| **context** | Дополнительный контекст | Проект Chat, iOS, SwiftUI |
| **files** | Релевантные файлы | ChatView.swift, Models/ |
| **constraints** | Ограничения | iOS 18.0+, Swift 6.0 |
| **references** | Ссылки на документацию | QWEN.md, GUIDELINES.md |

### 4.2 Пример передачи контекста

```
От: Client Lead
Кому: Client Developer

Задача: Добавить экран истории чатов

Контекст:
- Проект: Chat (iOS + LM Studio)
- UI: SwiftUI, MVVM
- Data: SwiftData
- Navigation: NavigationStack

Файлы:
- Features/History/Views/HistoryView.swift (существует)
- Models/ChatSession.swift (использовать)

Ограничения:
- SwiftLint 160 символов
- Docstrings на русском
- Использовать Design System (AppColors, Typography)

Ссылки:
- QWEN.md - обзор проекта
- GUIDELINES.md - код стайл
```

---

## 5. Workflows

### 5.1 UI Feature Workflow

```
USER REQUEST
     │
     ▼
┌─────────────────┐
│   Product Mgr   │ ← Оценивает приоритет
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Client Lead    │ ← Координирует
└────────┬────────┘
         │
    ┌────┴────┐
    ▼         ▼
┌───────┐ ┌────────┐
│Design │ │ Client │ ← Параллельно
│       │ │  Dev   │
└───┬───┘ └───┬────┘
    │         │
    └────┬────┘
         ▼
┌─────────────────┐
│  Client QA Lead │ ← Тестирует
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Client Lead    │ ← Code review
└────────┬────────┘
         │
         ▼
      MERGE
```

### 5.2 Security Audit Workflow

```
USER REQUEST: "Проведи security audit"
     │
     ▼
┌─────────────────┐
│   Server Lead   │ ← Инициирует
└────────┬────────┘
         │
    ┌────┴────┐
    ▼         ▼
┌──────────┐ ┌──────────────┐
│ Server   │ │   Client     │ ← Параллельно
│ Security │ │  Security    │
└────┬─────┘ └──────┬───────┘
     │              │
     └──────┬───────┘
            ▼
┌─────────────────┐
│  Staff Engineer │ ← Review
└────────┬────────┘
            │
            ▼
       ОТЧЁТ
```

### 5.3 Cross-Team Workflow

```
USER REQUEST: "Новый экран с API"
     │
     ▼
┌─────────────────┐
│      CTO        │ ← Routing
└────────┬────────┘
         │
    ┌────┴────┐
    ▼         ▼
┌────────┐ ┌─────────┐
│ Client │ │ Server  │
│  Lead  │ │  Lead   │
└───┬────┘ └────┬────┘
    │           │
    ▼           ▼
┌────────┐ ┌─────────┐
│Client  │ │ Server  │
│  Dev   │ │  Dev    │
└───┬────┘ └────┬────┘
    │           │
    └─────┬─────┘
          ▼
┌─────────────────┐
│   Full Stack    │
│   Integration   │
└─────────────────┘
```

---

## 6. Обработка ошибок

### 6.1 Агент не найден

```
User: "Сделай что-то непонятное"

→ Ни один агент не匹配
→ CTO как fallback
→ CTO анализирует и либо:
  ├── Выполняет сам (если в компетенции)
  ├── Перенаправляет к правильному агенту
  └── Запрашивает уточнение у пользователя
```

### 6.2 Конфликт агентов

```
Ситуация: Два агента хотят редактировать один файл

Решение:
1. Первый агент получает lock
2. Второй ждёт или работает с другим файлом
3. При merge - CTU resolution
```

### 6.3 Агент не может выполнить задачу

```
Ситуация: Agent skills не хватает

Решение:
1. Агент возвращает "нужен дополнительный контекст"
2. Запрашивает уточнение
3. CTO перенаправляет к другому агенту
```

---

## 7. Best Practices

### 7.1 Для вызывающего агента

✅ **Давайте:**
- Чёткое описание задачи
- Контекст проекта
- Релевантные файлы
- Ограничения (deadline, технологии)
- Ссылки на документацию

❌ **Не давайте:**
- Расплывчатые задачи ("сделай хорошо")
- Конфликтующие требования
- Слишком много агентов сразу

### 7.2 Для вызываемого агента

✅ **Делайте:**
- Запрашивайте уточнение если нужно
- Сообщайте о проблемах сразу
- Документируйте изменения
- Придерживайтесь конвенций проекта

❌ **Не делайте:**
- Не работайте вслепую
- Не игнорируйте ограничения
- Не меняйте то, что не просили

### 7.3 Для CTO (координатор)

✅ **Делайте:**
- Выбирайте правильного агента по контексту
- Объединяйте параллельные задачи
- Следите за зависимостями
- Обеспечивайте коммуникацию

---

## 8. Command Reference

### 8.1 Типичные команды

| Команда | Агент | Описание |
|---------|-------|----------|
| "Добавь экран..." | Client Developer | Новый UI |
| "Интегрируй API..." | Server Developer | Новый endpoint |
| "Спроектируй..." | Designer | UI/UX |
| "Проведи аудит..." | Security | Security review |
| "Протестируй..." | QA | Testing |
| "Документируй..." | Docs | Documentation |
| "Рефакторинг..." | Staff Engineer | Code quality |
| "Оптимизируй..." | Performance | Performance |

### 8.2 Сложные команды

| Команда | Кто координирует | Участники |
|---------|-----------------|-----------|
| "Новая фича" | Product Manager | Lead → Dev + QA + Design |
| "Security audit" | Server Lead | Security + Staff Engineer |
| "Performance review" | CTO | Performance + QA |
| "Миграция" | Staff Engineer | Multiple Devs |

---

## 9. Примеры взаимодействия

### Пример 1: Простая задача

```
User: "Добавь кнопку.settings в навигацию"

→ Client Developer (по ключу "кнопка", "навигация")
→ Исправляет NavigationStack
→ Результат: PR
```

### Пример 2: Средняя задача

```
User: "Создай экран выбора модели с загрузкой из LM Studio"

→ Client Lead (координирует)
  → Client Developer: UI + SwiftData
  → Server Developer: API для загрузки
  → Client QA Lead: Tests
  
→ Client Lead собирает результаты
→ Результат: PR
```

### Пример 3: Сложная задача

```
User: "Полный рефакторинг безопасности"

→ CTO (анализирует)
  → Server Lead координирует:
    → Server Security: Аудит
    → Server Developer: Исправления
    → Server QA: Tests
    
  → Client Lead координирует:
    → Client Security: Аудит
    → Client Developer: Исправления
    → Client QA: Tests
    
→ Staff Engineer: Final review
→ CTO: Approval
→ Результат: PR
```

---

## 10. Метрики команды

| Метрика | Цель | Как измерять |
|---------|------|--------------|
| Task success rate | >90% | Сколько задач выполнено |
| First-pass accuracy | >80% | Сколько с первого раза |
| Agent utilization | Сбалансировано | Распределение задач |
| Communication overhead | <20% | Время на координацию |

---

*Документ создан: 24 февраля 2026*
*Для вопросов: CTO Agent*
