# Инструкции для работы с проектом Chat

## Роли и взаимодействие

Проект — это совместная работа владельца и ИИ-команды:

- **Пользователь** (Владелец/Лид): Овнер, PM, лид разработки, тестирования, дизайна и девопса.
- **Junie** (ИИ): Команда помощников (менеджеры, разработчики, тестеры, дизайнеры, DevOps).

## Инструментарий

1. **Основная IDE**: JetBrains IntelliJ IDEA. Xcode — только для второстепенных задач.
2. **Язык документации**: Все комментарии в коде, KDoc и описания коммитов должны быть на **русском языке**.
3. **Стиль кода**:
    - Используйте Swift-стандарты (CamelCase для типов и свойств).
    - Обязательно добавляйте Docstrings (///) для всех публичных методов, структур и классов.
    - Разделяйте код на логические блоки с помощью `// MARK: -`.
4. **Архитектура**:
    - Проект использует MVVM + SwiftData.
    - Сетевой слой реализован через `HTTPClient` и `NetworkService`.
    - Для работы со стримингом используется `SSEParser`.

## Работа с API LM Studio

- Используйте v1 API LM Studio.
- Модели находятся в `Models/LMStudio/`.
- Базовый URL и тайм-ауты хранятся в `AppConfig`.

## Авторизация

- Авторизация привязана к устройству через `DeviceConfiguration` и `DeviceIdentity`.
- Токены хранятся только в Keychain через `KeychainHelper`.
- Не сохраняйте секреты в `UserDefaults`.

## Проверка качества и работоспособности (Workflows)

ДЛЯ ИИ-ПОМОЩНИКА: Перед каждым вызовом `submit`, вы ОБЯЗАНЫ запустить `swift run scripts check` с описанием изменений.
Это обеспечит:

1. Валидацию кода (Lint).
2. Работоспособность (Build + Test).
3. Синхронизацию изменений (Commit + Push).

### 1. Технический флоу (Check)

Предназначен для ИИ-помощника или разработчика. Позволяет быстро получить информацию о тестах и состоянии проекта.
Настроен на работу с симулятором без code signing, чтобы избежать запросов пароля.

```bash
swift run scripts check "Ваше описание изменений"
```

Что делает команда:

- Генерирует проект (XcodeGen).
- Проверяет стиль кода (SwiftLint).
- Генерирует ресурсы (SwiftGen).
- Собирает и запускает все Unit и UI тесты с выводом сводки.
- **Проверяет покрытие кода (code coverage) — должно быть 100%.**
- **Коммитит все изменения и делает push в удаленный репозиторий.**

### 2. Продуктовый флоу (Ship)

Используется для доставки готового продукта главному потребителю (боссу, тестеру). Предназначен для работы с **реальными
устройствами**.
Для удобства использования скрипт настроен на выполнение с привилегиями администратора (через sudo) без запроса пароля (требуется разовая настройка системы).

```bash
swift run scripts ship
```

Что делает команда:

- Собирает проект в Release конфигурации с подписанием кода.
- Устанавливает и запускает приложение на реальном устройстве **Saint Celestine**.
  *(Опирается на результат работы check)*

---

## Подробности проверок (при необходимости ручного запуска)

## Поддержание актуальности (Maintenance)

**Критическое правило для ИИ**: При любых изменениях в структуре проекта, ключевых компонентах или архитектуре, вы
ОБЯЗАНЫ проверить и при необходимости обновить следующие файлы:

1. `.junie/context.json` — техническая карта проекта.
2. `GUIDELINES.md` — общее руководство.
3. `.junie/instructions.md` — специфические инструкции.
   Информационная связность — залог корректной работы будущих сессий.

## Особенности UI

- Используйте дизайн-систему из папки `Design/` (`AppColors`, `AppSpacing`, `AppTypography`).
- Избегайте "магических чисел" в отступах и цветах.
- Используйте модификаторы из `Typography.swift` и `Spacing.swift` для единообразия.

## Ограничения разработки (Personal Team License)

Проект разрабатывается с учетом ограничений бесплатной/персональной команды Apple Developer (Personal Team). При
проектировании новых функций необходимо учитывать НЕДОСТУПНОСТЬ следующих инструментов и сервисов:

1. **CloudKit**: Использование облачного хранилища данных Apple невозможно.
2. **Push Notifications**: Удаленные уведомления не поддерживаются.
3. **In-App Purchases**: Тестирование и реализация покупок внутри приложения ограничены.
4. **App Groups**: Обмен данными между приложениями и расширениями через группы ограничен.
5. **Apple Pay**: Интеграция платежной системы невозможна.
6. **Siri & Game Center**: Эти сервисы недоступны для персональных команд.
7. **Срок действия профиля**: Профили подготовки (provisioning profiles) для бесплатных аккаунтов истекают через 7 дней.
8. **Лимит устройств**: Ограничение на количество зарегистрированных устройств для тестирования (обычно до 3).
9. **Распространение**: Невозможно распространение через TestFlight или App Store.

### Бес парольная настройка для ship (Один раз на всю жизнь)

Для без парольного запуска доставки на устройство:

1. Запустите: `swift run scripts configure-sudo`.
2. В терминале отобразится команда для добавления в `sudoers`.
3. Выполните её. Теперь `ship` будет иметь права админа навсегда без запроса пароля.

**Важное примечание по автоматизации**:

1. `check` — выполняется локально на **симуляторах** с флагами `CODE_SIGNING_ALLOWED=NO`. Это позволяет избежать
   запросов пароля Keychain и идеально подходит для CI/CD и ИИ-помощников.
2. `ship` — выполняется для доставки на **реальное устройство**. Требует подписания кода. Чтобы скрипт не запрашивал
   пароль при выполнении административных действий, рекомендуется настроить `sudoers` (см. `configure-sudo`).
