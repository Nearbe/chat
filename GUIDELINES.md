# Руководство по разработке проекта Chat

## Роли и команда
Проект ведется в формате тесного взаимодействия между владельцем и ИИ-командой:
- **@nearbe** (Владелец): Овнер, PM, лид разработки, тестирования, дизайна и DevOps. Принимает ключевые решения и задает вектор развития.
- **Junie** (ИИ-команда): Команда помощников-менеджеров, разработчиков, тестировщиков, дизайнеров и девопсеров. Реализует задачи, следит за качеством и документацией.

## Основная IDE
Основной средой разработки (IDE) для проекта является **JetBrains IntelliJ IDEA** (с плагином для Swift). Xcode используется исключительно как вспомогательный инструмент для специфических задач (управление симуляторами, низкоуровневая отладка, просмотр некоторых типов ресурсов).

## Структура проекта
- `Features/`: Функциональные модули приложения (Chat, History, Settings, Common). Каждая фича содержит свои View, ViewModel и компоненты.
- `App/`: Точка входа в приложение и глобальная конфигурация.
- `Core/`: Универсальные типы (`AnyCodable`), расширения и общие UI-утилиты.
- `Data/`: Настройка SwiftData (`PersistenceController`).
- `Design/`: Дизайн-система (цвета, отступы, типографика).
- `Models/`: Модели данных, разделенные на бизнес-модели и API-модели (в `Models/LMStudio`).
- `Services/`: Сервисов для авторизации (`Auth`), сети (`Network`), логики чата (`Chat`) и системных функций.

## Архитектурные принципы
Проект следует принципам чистой архитектуры и SOLID:
- **Dependency Injection**: Сервисы внедряются во ViewModel и другие сервисы через инициализаторы или EnvironmentObject.
- **Single Responsibility**: 
    - `ChatService` отвечает только за API.
    - `ChatSessionManager` отвечает только за сохранение данных.
    - `NetworkMonitor` отвечает только за статус сети.
    - `ChatViewModel` (в `Features/Chat`) управляет только состоянием UI.
- **Feature-based Structure**: Код организован по фичам, что упрощает навигацию и поддержку. Каждая фича самодостаточна в плане UI и логики представления.
- **AuthorizationProvider**: Вся логика авторизации изолирована через протоколы.
- `Features/`: SwiftUI компоненты и экраны, организованные по фичам.

## Важные файлы
- `.junie/instructions.md`: Специальные инструкции для ИИ-помощников.
- `.junie/context.json`: Архитектурная карта проекта для быстрого погружения.
- `Tools/Scripts/`: Скрипты автоматизации проекта на Swift (XcodeGen, SwiftGen, Check, Ship и др.). Команды запускаются через `./scripts <command>`.

## Работа со скриптами (Swift Scripts)
Все скрипты автоматизации написаны на Swift и доступны в IDE IDEA через Swift Package Manager.
Это позволяет использовать автодополнение, типизацию и отладку при редактировании логики скриптов.

Основные команды:
- `./scripts setup` — Подготовка проекта (XcodeGen + SwiftGen).
- `./scripts check` — Полная техническая проверка (выполняется асинхронно для ускорения).
- `./scripts ship` — Деплой на устройство.

Для настройки беспарольного запуска (если требуется):
1. Запустите: `./scripts configure-sudo`
2. Выполните предложенную команду. Она добавит путь к скомпилированному Swift-бинарнику в `sudoers`.
3. В дальнейшем используйте скомпилированный бинарник напрямую (путь будет указан после настройки), так как `swift run` может блокировать интерактивный ввод пароля.

## Документация и внешние ресурсы
В папке `Docs/` собрана документация по используемым инструментам и API:
- `Docs/LMStudio/`: Полная документация по REST API и CLI LM Studio.
- `Docs/Ollama/`: Спецификация API Ollama.
- `Docs/OpenAI/`: Спецификация OpenAI API (совместимость).
- `Docs/Factory/` и `Docs/Pulse/`: Документация по ключевым библиотекам.
- `Docs/Codegen/`: Инструкции по XcodeGen и SwiftGen.

Для обновления этих данных используйте `./scripts download-docs`.

## Стандарты разработки
- Комментарии и документация пишутся на **русском языке**.
- Любые изменения в моделях API должны быть согласованы со спецификацией LM Studio v1.
- Новые UI компоненты должны использовать константы из `AppColors`, `AppSpacing` и `AppTypography`.
- Секретные данные (токены) хранятся **только** в Keychain.
- **Ограничения Personal Team**: Разработка ведется с учетом лимитов персональной команды Apple Developer. Недопустимо использование CloudKit, Push Notifications, In-App Purchases, Apple Pay и других сервисов, требующих платной подписки Apple Developer Program. Автоматизация (`check.sh`) настроена на использование симуляторов без подписания кода, чтобы избежать запросов пароля.
## Тестирование
В проекте используются современные подходы к автоматизированному тестированию:

1. **Unit-тесты (Swift Testing)**:
   - Используйте фреймворк Swift Testing (`import Testing`).
   - Применяйте паттерн **AAA (Arrange, Act, Assert)**. В комментариях используйте: `// Given`, `// When`, `// Then`.
   - Для повторяющихся тестов с разными данными используйте параметризацию: `@Test(arguments: [...])`.
   - Для проверки выброса ошибок используйте макрос `#expect(throws: ...)`.
   - Используйте фабрики тестовых данных (`extension Model.make(...)`) из `TestHelpers.swift` для уменьшения дублирования кода.

2. **UI-тесты (XCTest + Page Object Model)**:
   - Используйте паттерн **Page Object Model (POM)** для изоляции логики тестов от деталей интерфейса.
   - Все страницы должны находиться в `ChatUITests/Pages/`.
   - Элементы интерфейса должны иметь `accessibilityIdentifier` для стабильного поиска.

3. **Снапшот-тесты (SnapshotTesting)**:
   - Используются для проверки визуальной регрессии UI-компонентов.
   - Хранятся в `ChatTests/__Snapshots__`.

4. **Общие правила**:
   - Тесты должны быть независимыми и изолированными (не полагаться на состояние других тестов).
   - Все комментарии в тестах должны быть на **русском языке**.

## Порядок внесения изменений (Change Management)
Чтобы проект оставался поддерживаемым, а информация в нем актуальной, при внесении изменений следуйте этим шагам:
1. **Обновление структуры папок или ключевых файлов**:
   - Если вы добавляете, удаляете или перемещаете папку/файл, обязательно отразите это в `GUIDELINES.md` в разделе "Структура проекта".
   - Обновите техническую карту в `.junie/context.json`, если изменились ключевые точки входа (`key_entry_points`).
2. **Изменение архитектурных подходов**:
   - Если в проект внедряется новая технология или меняется способ работы с существующей (например, замена SwiftData на CoreData), обновите `.junie/instructions.md` и `GUIDELINES.md`.
3. **Добавление нового функционала**:
   - Новые функции должны сопровождаться комментариями на русском языке (Docstrings).
   - Если функционал требует настройки окружения, обновите логику в `Tools/Scripts/Sources/Scripts/Commands/Setup.swift`.
4. **Синхронизация документации**:
   - После завершения работы проверьте, что `GUIDELINES.md`, `.junie/context.json` и `.junie/instructions.md` согласованы между собой.
5. **Проверки качества и коммит**:
   - Перед отправкой изменений ОБЯЗАТЕЛЬНО выполните `./scripts check`.
   - Если требуется доставить продукт для проверки, выполните `./scripts ship` ПОСЛЕ `./scripts check`.
   - Что делает `./scripts check` (выполняется максимально асинхронно):
     - `swiftlint` (параллельно всему остальному)
     - `xcodegen` + `swiftgen` (подготовка проекта)
     - `xcodebuild ... test` (Unit + UI тесты параллельно внутри xcodebuild)
     - `xcodebuild ... build` (Release сборка параллельно с тестами)
     - **Проверка покрытия кода (должна быть 100%)**
     - **Автоматический коммит и push**
## Метрики и статистика
В проект встроена система автоматического сбора метрик времени выполнения скриптов. 
Информация сохраняется в файл `metrics.csv` в корне проекта при каждом запуске команд через `./scripts`.

Данные в `metrics.csv` включают:
- Дату и время запуска.
- Название этапа (Step).
- Длительность в секундах.
- Статус (Success/Failure).

Это позволяет отслеживать производительность процессов автоматизации и оптимизировать медленные этапы.

## Стек технологий
- Swift 6.0
- SwiftUI
- SwiftData
- XcodeGen
- SwiftGen
- Factory (Dependency Injection)
- Pulse (Logging & Network Monitoring) — Консоль открывается **двойным тапом** по заголовку "Chat" на главном экране.
- SnapshotTesting (Visual Regression Testing)
- Apple Security framework (Keychain)
- SwiftLint (Code Quality)
