# План развития тестирования проекта Chat

Этот документ описывает стратегию и конкретные шаги по расширению тестового покрытия приложения.

## 1. Unit-тесты для ViewModel (`ChatViewModelTests`)
`ChatViewModel` — сердце приложения. Необходимо покрыть тестами следующие сценарии:

- **Авторизация**:
    - Проверка `isAuthenticated` после вызова `saveToken`.
    - Сброс состояния авторизации при очистке Keychain.
- **Управление моделями**:
    - Успешная загрузка списка моделей (`loadModels`).
    - Обработка ошибок сети при загрузке моделей (сервер недоступен).
    - Автоматический сброс `selectedModel`, если выбранная модель больше не предоставляется сервером.
- **Работа с сообщениями**:
    - `sendMessage`: проверка создания сессии и добавления `user` сообщения.
    - `generateResponse`: имитация стриминга через мок `ChatService`. Проверка постепенного обновления текста `assistant`.
    - `stopGeneration`: проверка отмены текущей задачи и корректного завершения состояния `isGenerating`.
    - `editMessage`: проверка удаления последующих сообщений и запуска новой генерации.
- **Управление сессиями**:
    - Корректное переключение между сессиями через `setSession`.
    - Удаление сессий и очистка UI.

## 2. Тестирование работы с данными (`ChatSessionManagerTests`)
Необходимо убедиться в надежности сохранения истории чатов. Для тестов следует использовать **in-memory ModelContainer** SwiftData.

- **Операции CRUD**:
    - Создание сессии с валидным заголовком и моделью.
    - Добавление сообщений (проверка связей и индексов).
    - Удаление сообщений и сессий.
    - Массовое удаление сообщений после определенного индекса (при редактировании).

## 3. Тестирование API и моделей (`ModelDecodingTests`)
Поскольку приложение зависит от внешних API (LM Studio/OpenAI), важно гарантировать правильный парсинг данных.

- **Декодирование JSON**:
    - Парсинг чанк-ответов (`LMStreamChunk`).
    - Парсинг полных ответов (`ChatCompletionResponse`).
    - Обработка ошибок, возвращаемых API в формате JSON.

## 4. Интеграционные тесты (`ChatServiceTests`)
Проверка взаимодействия между слоями без участия UI.

- **ChatService**:
    - Правильное формирование HTTP-запросов (URL, Auth-заголовки).
    - Корректная обработка SSE-потока и его трансформация в модели приложения.
    - Проверка обработки сетевых таймаутов.

## 5. UI-тесты (`ChatUITests`)
Автоматизация проверки пользовательских сценариев.

- **Основной цикл**:
    - Запуск приложения -> Авторизация (ввод токена) -> Переход в чат.
    - Отправка сообщения и визуальная проверка появления "баббла" в списке.
- **Навигация**:
    - Открытие боковой панели истории.
    - Переключение на другую сессию.
    - Вызов селектора моделей.
- **Accessibility**:
    - Проверка наличия меток доступности для основных кнопок.

## 6. Инфраструктура для тестов
- [ ] Добавить `ChatViewModelTests.swift`.
- [ ] Добавить `ChatSessionManagerTests.swift`.
- [ ] Добавить `ModelDecodingTests.swift`.
- [ ] Создать `Mocks` для `ChatService`, `NetworkMonitor`.
- [ ] Реализовать `TestHelpers` для удобной работы с SwiftData в тестах.

---
*План составлен на основе текущей архитектуры (MVVM + Factory + SwiftData).*
